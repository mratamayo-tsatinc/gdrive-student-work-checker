<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <style>
      .mdl-dialog {
        margin-top: 24px;
        width: 90%;
      }
      .mdl-dialog-content { padding: 24px; min-width: 400px; }
      .mdl-dialog-actions { text-align: right; padding: 8px 24px 24px 24px; }
      #status { margin-top: 16px; color: #333; }
      .overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.85);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .overlay.active { display: flex; }
      .mdl-spinner { margin: 0 auto; }
      .student-row { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; }
      .item-col { flex: 2; }
      .score-col { flex: 1; }
      .action-col { flex: 1; text-align: right; }
      .folder-name { font-weight: bold; color: #3f51b5; cursor: pointer; }
      .folder-id { font-size: 12px; color: #888; }
      .score-input { width: 60px; }
      /* Snackbar styles */
      #snackbar {
        visibility: hidden;
        min-width: 288px;
        max-width: 568px;
        background-color: #323232;
        color: #fff;
        text-align: left;
        border-radius: 2px;
        padding: 16px 24px;
        position: fixed;
        left: 50%;
        bottom: 32px;
        transform: translateX(-50%);
        z-index: 2000;
        font-size: 14px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.26);
        transition: visibility 0s, opacity 0.3s linear;
        opacity: 0;
      }
      #snackbar.show {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.3s linear;
      }
      #snackbar.success {
        background-color: #43a047;
      }
      #snackbar.error {
        background-color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <dialog class="mdl-dialog" open>
      <div class="mdl-dialog-content">
        <h5 class="mdl-dialog__title">Student Task Submission</h5>
        <div id="student-list"></div>
        <div id="status" style="display:none"></div>
      </div>
      <div class="mdl-dialog-actions">
        <button class="mdl-button mdl-js-button mdl-button--raised" onclick="window.close()">Close</button>
      </div>
      <div id="overlay" class="overlay">
        <div>
          <div class="mdl-spinner mdl-js-spinner is-active" style="width:48px;height:48px;"></div>
          <div style="text-align:center;margin-top:16px;">Processing...</div>
        </div>
      </div>
    </dialog>
    <div id="snackbar"></div>
    <script>
      function showSnackbar(message, type) {
        var snackbar = document.getElementById('snackbar');
        snackbar.textContent = message;
        snackbar.className = 'show' + (type === 'error' ? ' error' : ' success');
        setTimeout(function() {
          snackbar.className = snackbar.className.replace('show', '');
        }, 4000);
      }

      function setOverlay(active) {
        var overlay = document.getElementById('overlay');
        if (active) overlay.classList.add('active');
        else overlay.classList.remove('active');
      }

      function renderStudentList(data) {
        var listDiv = document.getElementById('student-list');
        if (!data.folders.length) {
          listDiv.innerHTML = '<div>No student folders found.</div>';
          return;
        }
        var html = `
          <div style="display:flex;font-weight:bold;border-bottom:2px solid #ccc;padding-bottom:4px;margin-bottom:8px;">
            <div class="item-col">Item</div>
            <div class="score-col">Score</div>
            <div class="action-col">Action</div>
          </div>
        `;
        data.folders.forEach(function(folder) {
          var score = data.scores[folder.id] || 0;
          html += `
            <div class="student-row">
              <div class="item-col">
                <span class="folder-name" onclick="window.open('https://drive.google.com/drive/folders/${folder.id}','_blank')">${folder.name}</span>
                <div class="folder-id">${folder.id}</div>
              </div>
              <div class="score-col">
                <input class="mdl-textfield__input score-input" type="number" min="0" value="${score}" id="score-${folder.id}" onchange="updateScore('${folder.id}')">
              </div>
              <div class="action-col">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="analyze('${folder.id}')">Analyze</button>
                <button class="mdl-button mdl-js-button mdl-button--raised" onclick="evaluateStudent('${folder.id}')">Evaluate</button>
              </div>
            </div>
          `;
        });
        listDiv.innerHTML = html;
        componentHandler.upgradeDom();
      }

      function updateScore(folderId) {
        var val = document.getElementById('score-' + folderId).value;
        setOverlay(true);
        google.script.run
          .withSuccessHandler(function(msg) {
            setOverlay(false);
            showSnackbar(msg, 'success');
          })
          .withFailureHandler(function(err) {
            setOverlay(false);
            showSnackbar('Error: ' + err.message, 'error');
          })
          .updateStudentScore(folderId, Number(val));
      }

      function analyze(folderId) {
        setOverlay(true);
        google.script.run
          .withSuccessHandler(function(msg) {
            setOverlay(false);
            showSnackbar(msg, 'success');
          })
          .withFailureHandler(function(err) {
            setOverlay(false);
            showSnackbar('Error: ' + err.message, 'error');
          })
          .analyzeStudentFolder(folderId);
      }

      function evaluateStudent(folderId) {
        setOverlay(true);
        google.script.run
          .withSuccessHandler(function(msg) {
            setOverlay(false);
            showSnackbar(msg, 'success');
            // Optionally, refresh the list to update the score column
            google.script.run
              .withSuccessHandler(function(data) {
                renderStudentList(data);
              })
              .getStudentFoldersAndScores();
          })
          .withFailureHandler(function(err) {
            setOverlay(false);
            showSnackbar('Error: ' + err.message, 'error');
          })
          .evaluateStudentFolder(folderId);
      }

      // Initial load
      setOverlay(true);
      google.script.run
        .withSuccessHandler(function(data) {
          setOverlay(false);
          renderStudentList(data);
        })
        .withFailureHandler(function(err) {
          setOverlay(false);
          showSnackbar('Error: ' + err.message, 'error');
          document.getElementById('student-list').innerHTML = 'Error: ' + err.message;
        })
        .getStudentFoldersAndScores();
    </script>
  </body>
</html>